* blame-reveal.el

A contextual, high-performance Git blame UI for Emacs with recursive history navigation.

** Philosophy

#+begin_quote
Blame is context, not decoration.

blame-reveal displays only what matters — visible lines and recent commits — keeping Emacs responsive even on very large files.
#+end_quote

Unlike traditional blame tools that process entire files upfront, =blame-reveal= renders only the visible viewport plus a margin. This ensures instant activation, smooth scrolling, and minimal resource usage.

[[file:assets/recent-commits.jpg]]

[[file:assets/relatively-old-commits.jpg]]

The green margin here is the effect of the [[https://github.com/dgutov/diff-hl][diff-hl]] package, used in combination as follows.

[[file:assets/uncommit.jpg]]

** Features

*** Visual Indicators

- *Color-coded fringe blocks* (IDEA-style)
  - Recent commits (top N, within time limit): Gradient colors, always visible
  - Old commits: Derived color, visible only when cursor is on them
  - Automatic theme adaptation (dark/light)

- *Inline commit headers* above each block
  - Formats: =line= / =compact= / =full=
  - Styles: =background= / =box= / =inverse=
  - Customizable typography
*** Sticky Header

Automatically shows commit info at window top when the block header scrolls completely off-screen.

[[file:assets/sticky-header.jpg]]

*Behavior*:
- Appears only when block header is fully scrolled out of view
- Marked with  indicator to distinguish from regular headers
- Disappears when cursor leaves the block or header becomes visible again
- Works automatically - no configuration needed

*Example*:

#+begin_example
Before scrolling:
┌───────────────────────────┐
│ ▸ Add login feature       │ ← Regular header
│   abc123 • Alice • 2d ago │
│ |                          │
│   def login():             │
│     code...                │ ← Cursor
└───────────────────────────┘

After scrolling down:
┌───────────────────────────┐ ← Window top
│ |  Add login feature     │ ← Sticky header (original is above)
│ |  abc123 • Alice • 2d   │
│ |                          │
│ |     more code...         │ ← Cursor
└───────────────────────────┘
#+end_example

*Multi-block handling*:

When a commit has multiple non-contiguous blocks, sticky header only appears for the specific block you're in:

#+begin_example
┌───────────────────────────┐
│ [Block A scrolled away]   │ ← Header off-screen
├───────────────────────────┤ ← Window top
│ ▸ Same commit - Block B   │ ← Regular header visible ✓
│   abc123 • Alice • 2d ago │
│ |                          │
│   def bar():               │ ← Cursor in Block B
│     code...                │
└───────────────────────────┘

No sticky header shown - Block B's header is visible.
#+end_example

*Common use cases*: Long commits, large functions, split-window workflows.

*** Commit Selection & Colors

Recent commits must satisfy *both* conditions (except in recursive blame):

#+begin_src
Active Project (many recent commits):
═══════════════════════════════════════════════════════════════
C1-C20  (within 90d)  → Gradient colors (newest = brightest)
C21+    (>90d or not top 20) → Derived color (dimmed)

Inactive Project (few recent commits):
═══════════════════════════════════════════════════════════════
C1-C2   (within 90d)  → Gradient colors
C3-C20  (>90d)        → Derived color (dimmed)
#+end_src

/Auto-Expand Mode/ (=blame-reveal-auto-expand-recent=):
- =t= (default): All commits within time limit (ignores count)
- =nil=: Strictly top N AND within time limit

/Recursive Blame Exception/: Time limit always ignored (shows top N at that point in history)

*** Recursive Blame Navigation

Navigate through the complete history of a line:

#+begin_src
Example workflow:
  Line 50: Bob (def456) at HEAD
  Mode line: [HEAD] ← Which snapshot you're viewing

  Press 'b': Bob (def456) → Charlie (ghi789)
  Mode line: [def456^]

  Press 'b': Charlie (ghi789) → Dave (jkl012)
  Mode line: [ghi789^]

  Press 'r': Reset to HEAD

Note: The mode line shows which file version you're viewing,
      while line annotations show who last modified each line.
      These can differ when commits change other lines.

Use cases:
  - Find original author of a line
  - Track bug introduction point
  - Understand code evolution
#+end_src

*** Performance

/Lazy Loading/ (configurable threshold):
- Small files (< 5000 lines): Full load
- Large files (≥ 5000 lines): Visible region only, expand on scroll

/Incremental Loading/:
1. Visible commits (immediate)
2. Remaining commits (background, on-demand)
3. Re-render only when needed

/Benchmarks/ (10,000+ lines, 500+ commits):

| Operation       | Time   | Notes          |
|-----------------+--------+----------------|
| Initial load    | <100ms | Visible region |
| Scroll          | <50ms  | Debounced      |
| Recursive blame | <200ms | Full file load |
| Memory          | ~1-2MB | Per buffer     |

*** Interactive Commands

| Key | Command                          | Action                 |
|-----+----------------------------------+------------------------|
| =q=   | =blame-reveal-mode=                | Toggle                 |
| =c=   | =blame-reveal-copy-commit-hash=    | Copy hash              |
| =d=   | =blame-reveal-show-commit-diff=    | Show diff              |
| =s=   | =blame-reveal-show-commit-details= | Full message           |
| =h=   | =blame-reveal-show-file-history=   | File log               |
| =l=   | =blame-reveal-show-line-history=   | Line log               |
| =b=   | =blame-reveal-blame-recursively=   | Blame at parent commit |
| =p/^= | =blame-reveal-blame-back=          | Return to previous     |
| =g=   | =blame-reveal-blame-at-revision=   | Blame at specific rev  |
| =r=   | =blame-reveal-reset-to-head=       | Reset to HEAD          |

** Installation

#+begin_src elisp
;; Manual
(add-to-list 'load-path "/path/to/blame-reveal")
(require 'blame-reveal)
(require 'blame-reveal-recursive)  ; Optional: for recursive blame

;; use-package
(use-package blame-reveal
  :load-path "/path/to/blame-reveal"
  :commands blame-reveal-mode
  :config
  (require 'blame-reveal-recursive))
#+end_src

** Usage

#+begin_src elisp
M-x blame-reveal-mode

;; Or auto-enable
(add-hook 'prog-mode-hook #'blame-reveal-mode)
#+end_src

** Customization

*** Display & Typography

#+begin_src elisp
;; Fringe & Layout
(setq blame-reveal-style 'left-fringe)          ; 'left-fringe, 'right-fringe
(setq blame-reveal-display-layout 'compact)     ; 'line, 'compact, 'full
(setq blame-reveal-display-style 'background)   ; 'background, 'box, 'inverse

;; Typography (commit message)
(setq blame-reveal-header-weight 'bold
      blame-reveal-header-height 1.0)

;; Typography (metadata: hash, author, date)
(setq blame-reveal-metadata-weight 'normal
      blame-reveal-metadata-height 0.9)

;; Typography (description)
(setq blame-reveal-description-weight 'normal
      blame-reveal-description-height 0.9)
#+end_src

*** Color Scheme

The gradient uses HSL parameters. Old commits get a derived color (darker/lighter than oldest recent):

#+begin_src elisp
;; Default (Blue)
(setq blame-reveal-color-scheme
      '(:hue 210                    ; 0=red, 120=green, 210=blue, 280=purple
        :dark-newest 0.70           ; Dark theme: higher = brighter
        :dark-oldest 0.35
        :light-newest 0.45          ; Light theme: lower = darker
        :light-oldest 0.75
        :saturation-min 0.25        ; Oldest commits
        :saturation-max 0.60))      ; Newest commits

;; Presets
(setq blame-reveal-color-scheme
      '(:hue 210 :dark-newest 0.75 :dark-oldest 0.30
        :light-newest 0.35 :light-oldest 0.85
        :saturation-min 0.35 :saturation-max 0.70))  ; High contrast

(setq blame-reveal-color-scheme
      '(:hue 120 :dark-newest 0.70 :dark-oldest 0.35
        :light-newest 0.40 :light-oldest 0.75
        :saturation-min 0.25 :saturation-max 0.60))  ; Green

(setq blame-reveal-color-scheme
      '(:hue 280 :dark-newest 0.70 :dark-oldest 0.35
        :light-newest 0.45 :light-oldest 0.75
        :saturation-min 0.25 :saturation-max 0.60))  ; Purple
#+end_src

*** Commit Selection

#+begin_src elisp
;; How many commits to highlight
(setq blame-reveal-recent-commit-count 20)      ; Default: 20

;; Maximum age for recent commits (days)
(setq blame-reveal-recent-days-limit 90)        ; Default: 90 (nil = no limit)

;; Auto-expand: all within time vs strict top N
(setq blame-reveal-auto-expand-recent t)        ; Default: t

;; Recursive blame: ignore time limit?
(setq blame-reveal-recursive-ignore-time-limit t)  ; Default: t (recommended)

;; Examples:
;; Active project: all commits from last month
(setq blame-reveal-auto-expand-recent t
      blame-reveal-recent-days-limit 30
      blame-reveal-recursive-ignore-time-limit t)

;; Inactive project: exactly top 10, no time limit
(setq blame-reveal-auto-expand-recent nil
      blame-reveal-recent-commit-count 10
      blame-reveal-recent-days-limit nil
      blame-reveal-recursive-ignore-time-limit t)

;; Strict mode: always respect time limit (even in recursive)
(setq blame-reveal-auto-expand-recent nil
      blame-reveal-recent-days-limit 90
      blame-reveal-recursive-ignore-time-limit nil)
#+end_src

How these work together:/

| Mode            | =auto-expand= | =ignore-time= | Behavior                      |
|-----------------+-------------+-------------+-------------------------------|
| Normal blame    | =t=           | N/A         | All commits within time limit |
| Normal blame    | =nil=         | N/A         | Top N AND within time limit   |
| Recursive blame | any         | =t=           | Top N (time ignored)          |
| Recursive blame | =t=           | =nil=         | All within time limit         |
| Recursive blame | =nil=         | =nil=         | Top N AND within time limit   |

/Why =ignore-time=t= is recommended for recursive blame:/

When viewing a revision from 3 years ago, filtering by "last 90 days from now" would show nothing useful. Setting this to =t= shows the N most recent commits /at that point in history/, making historical exploration meaningful.

*** Uncommitted Changes

#+begin_src elisp
(setq blame-reveal-uncommitted-label "Uncommitted changes")
(setq blame-reveal-uncommitted-color nil)           ; Auto theme-based
(setq blame-reveal-show-uncommitted-fringe nil)     ; Only header, no fringe
#+end_src

/Tip/: Keep =show-uncommitted-fringe= as =nil= when using [[https://github.com/dgutov/diff-hl][diff-hl]]:

#+begin_src elisp
(use-package diff-hl
  :config
  (global-diff-hl-mode)
  (diff-hl-margin-mode))  ; Recommended

(use-package blame-reveal
  :config
  (setq blame-reveal-show-uncommitted-fringe nil))
#+end_src

*** Color Overrides

#+begin_src elisp
;; Override auto gradient
(setq blame-reveal-recent-commit-color nil)         ; Auto gradient (default)
;;    blame-reveal-recent-commit-color "#6699cc")   ; Fixed color
;;    blame-reveal-recent-commit-color
;;      (lambda (ts) ...))                          ; Custom function

;; Override derived color for old commits
(setq blame-reveal-old-commit-color nil)            ; Auto derived (default)
;;    blame-reveal-old-commit-color "#888888")      ; Fixed color
#+end_src

*** Performance

#+begin_src elisp
(setq blame-reveal-render-margin 50)            ; Lines beyond viewport
(setq blame-reveal-lazy-load-threshold 5000)    ; Lazy load files ≥ 5000 lines
(setq blame-reveal-temp-overlay-delay 0.05)     ; Old commit overlay delay (s)
#+end_src

*** Magit Integration

#+begin_src elisp
(setq blame-reveal-use-magit 'auto)  ; 'auto, t, or nil
#+end_src

** Tips

*** Project-Specific Presets

#+begin_src elisp
;; Active projects (many commits/day)
(setq blame-reveal-recent-days-limit 7
      blame-reveal-auto-expand-recent t)

;; Inactive projects
(setq blame-reveal-recent-days-limit nil
      blame-reveal-recent-commit-count 10)

;; Large files
(setq blame-reveal-render-margin 100
      blame-reveal-lazy-load-threshold 3000)
#+end_src

*** Recursive Blame Workflow

#+begin_src
Finding original author:
  1. Navigate to line → Press 'b' repeatedly
  2. Stop at original implementation → Press 'r' to reset

Tracking bug introduction:
  1. Find buggy line → Press 'b' until bug disappears
  2. Last commit with bug is the culprit

Exploring refactoring:
  1. Find refactored code → Press 'b' to see before
  2. Press 'g' to jump to specific version
#+end_src

** Comparison

| Feature            | blame-reveal | git-gutter+ | blamer.el |
|--------------------+--------------+-------------+-----------|
| Viewport rendering | ✓           | ✗           | ✗         |
| Lazy loading       | ✓           | ✗           | ✗         |
| Large files (10k+) | ✓           | ~           | ✗         |
| IDEA-style colors  | ✓           | ✗           | ~         |
| Recursive blame    | ✓           | ✗           | ✗         |
| Magit integration  | ✓           | ✗           | ✗         |

** Requirements

- Emacs 27.1+
- Git CLI
- Optional: Magit

** License

GPL-3.0-or-later

** Author

Lucius Chen
